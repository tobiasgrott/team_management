name: Flutter CI

# This workflow is triggered on pushes to the repository.

on:
  push:
    branches:
    - master

jobs:
  build:
    
    # This job will run on ubuntu virtual machine
    runs-on: ubuntu-latest
    steps:

    # Set Release Version Number
    - name: Export Release Timestamp
      run: echo "::set-env name=APP_VERSION::release_$(date + '%Y-%m-%d_%H-%m-%S')"

    # Setup Java environment in order to build the Android app
    - uses: actions/checkout@v1
    - uses: actions/setup-java@v1
      with:
        java-version: '12.x'
    
    # Setup the flutter environment.
    - uses: subosito/flutter-action@v1
      with:
        channel: 'dev' # 'dev', 'alpha', default to: 'stable'
        # flutter-version: '1.12.x' # you can also specify exact version of flutter
    
    # Get flutter dependencies
    - run: flutter pub get

    # Check for any formatting issues in the code
    - run: flutter format --set-exit-if-changed .

    # Statically analyze the Dart code for any errors.
    - run: flutter analyze .

    # Run widget tests for our flutter project.
    - run: flutter test

    # Build apk.
    - run: flutter build apk --split-per-abi
    
    # Build ios
    # needs runs-on: macos-latest
    # - name: Build iOS App
    #   run: |
    #     flutter build ios --no-codesign
    #     cd build/ios/iphoneos
    #     mkdir Payload
    #     cd Payload
    #     ln -s ../Runner.app
    #     cd ..
    #    zip -r app.ipa Payload

    # Build Web App
    - name: Build Web App
      run: |
        flutter build web
        cd build/web
        zip -r web-app.zip .

    - name: Create a Release APK
      #if: startsWith(github.ref, 'refs/tags/')
      uses: ncipollo/release-action@v1
      with: 
        tag: ${{ env.APP_VERSION }}
        name: ${{ env.APP_VERSION }}
        # build/ios/iphoneos/app.ipa
        artifacts: "build/app/outputs/apk/release/*.apk,build/web/wep-app.zip"
        token: ${{ secrets.TOKEN }}
